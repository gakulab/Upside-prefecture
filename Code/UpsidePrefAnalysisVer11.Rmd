---
title: "UpsidePrefAnalysisVer6"
author: "keikawamura"
date: '`r format(Sys.Date(), "%y/%m/%d")`'
output: html_document
---
======= Ver.11の変更点 =======

・「<修論用>三陸の魚種リスト」チャンクを追加
・漁獲データ（海面漁業生産統計調査）において2019年確報値がリリースされたので内容を更新
※更新データを使用しているのは、今回追加したチャンクのみである！！！




## パッケージの読み込み  {.tabset .tabset-fade} 

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

#緩衝の初期化
rm(list = ls(all=TRUE))


library(tidyverse) #pipe関数
library(data.table) #データの読み込み
library(gghighlight) #gghilightのため
library(gridExtra) #grid.arrageのため
library(magrittr) #複雑なpipe関数
library(zoo) #移動平均用。zooは時系列分析用パッケージ
library(ggrepel) #geom_text_repelのため
library(ggthemes) #ggplotのテーマ集
library(googlesheets4) #google spreadsheetを読み込むパッケージ

```

## データの読み込み

```{r}
#Upside関連の結果を読み込む
## パッケージの読み込み  {.tabset .tabset-fade} 
setwd("/Volumes/GoogleDrive/My Drive/Upside-prefecture/Data_Working")
load("UpsideDataForResearch2.rda")
#系群データに資源状態(令和元年度版)を付与したもの
multi_stock_plus <- read.csv("FishStock.csv",stringsAsFactors = F)


#産業連関表関連の結果を読み込む。IOTs = Input Output Tables
gs4_auth()
IOTs <- read_sheet("1PDzMRzgPt0ctCOrD76lgrqTjea3TGMFD-8vtkPOdeQA",sheet = "summary")

#岩手の産業連関表の単位は千円だが、宮城の産業連関表の単位は100万円である。
IOTs_Iwate <- read_sheet("1PDzMRzgPt0ctCOrD76lgrqTjea3TGMFD-8vtkPOdeQA",sheet = "iwate_H25_103")
IOTs_Miyagi <- read_sheet("1PDzMRzgPt0ctCOrD76lgrqTjea3TGMFD-8vtkPOdeQA",sheet = "miyagi_H27_101")

#稼ぐ力関係
 setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Other/産業連関表/For_Analysis")
TokkaKeisu <- read_csv("全国市町村_修正特化係数_2016_稼ぐ力.csv")
Jugyouin <- read_csv("全国市町村_修正特化係数_2016_従業員比率.csv")
Jisokuritsu <- read_csv("全国市町村_修正特化係数_2016_自足率.csv")
```

## 時系列グラフ

新しいことが全て正しいとは限らない！（filterよりも[]を用いたフィルタリングの方が高速である等）
特に簡単な作業の場合は古典的な関数の方が高速であることが多い。新しい関数は拡張性に富んでいる一方で遅い場合が多々有る。

絶対量ではなく、相対量での時系列を用いる。これはシミュレーション結果と現実の乖離を感じさせないためである。シミュレーション結果は現実の値と乖離がある。これには、取り扱う魚種数に起因している部分もある。
```{r}
#lapplyでloopをまわす。forやmapよりも高速。
lapply(1:length(unique(UpsideResult$prefecture)), function(x){
  
  #2016年（シミュレーション１年目）のSQ（現状維持政策）におけるtotal_pref_catch（合計漁獲量：t）を基準値として抽出。
  standard <- as.numeric(na.omit(UpsideResult[UpsideResult$prefecture==unique(UpsideResult$prefecture)[x] & UpsideResult$management == "SQ" & UpsideResult$year == 2016,])[,5]) 
  
  #時系列グラフのためのデータ構築
  ggdata <- UpsideResult %>%
    filter(prefecture == unique(UpsideResult$prefecture)[x],
           management %in% c("SQ","FMSY")) %>%
    mutate(compare = (total_pref_catch/standard),
           year = year-2015,　 #西暦から変更
           management = ifelse(management == "SQ","現状維持政策","MSY漁獲政策"))
  
  
  #時系列グラフ
g1 <- ggplot(ggdata, aes(x = year,y = compare, color = management)) +
  theme_hc()+ 
  labs(x="年数", y="漁獲量比") +
  #labs(title = paste(unique(UpsideResult$prefecture)[x],"におけるシミュレーション１年目を基準とした漁獲量の変化",sep = "")) +
  scale_x_continuous(breaks = c(1,10,20,30,40,50)) + 
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800")) +
  geom_line(size = 3)+
  facet_wrap(~prefecture) +
  geom_text_repel(
      data = subset(ggdata, year == 50),
      aes(label = management,
          family = "Osaka"),
          vjust = -0.5,
          hjust = 1.2,
          size = 8,
          segment.color = NA
    ) +
  theme(plot.title = element_text(size = 20),
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"),
        strip.text.x = element_text(size = 30),
        legend.position = "none",
        text = element_text(family = "Osaka"))+
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.008)

  
  
  #棒グラフのためのデータ構築
  ggdata2 <- ggdata %>%
    #不要なデータを乗り除く
    select(!c(total_pref_price,compare,catch_yearly_rank)) %>%
    #計算しやすい様に変形(spreadは旧式、pivot_widerが新型)
    pivot_wider(names_from = management,values_from = total_pref_catch) %>%
    #SQに対するFMSYの比率の計算
    summarise(prefecture,
              year,
              compare = (MSY漁獲政策/現状維持政策)-1,
              結果 = ifelse(compare>0,"MSY漁獲政策>現状維持政策","MSY漁獲政策<現状維持政策"))  
  
  #棒グラフ
g2 <- ggplot(ggdata2, aes(x = year,y = compare,fill=結果)) +
  labs(x="年数", y="比率") +
  theme_light() +
  #labs(title = unique(UpsideResult$prefecture)[x]) +
  #labs(title = "時系列") +
  scale_x_continuous(breaks = c(1,10,20,30,40,50)) + 
  #scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800")) +
  scale_fill_manual(values=c("MSY漁獲政策>現状維持政策"="#00552e","MSY漁獲政策<現状維持政策"="#68be8d")) +
  geom_bar(stat = "identity",position = "dodge")+
  facet_wrap(~prefecture) +
  #gghighlight(calculate_per_facet = T,label_params = list(size = 13,family = "Osaka")) +
  #geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),
   #                fill = "blue", alpha = 0.009) +
  #gghighlight(calculate_per_facet = T) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"),
        #strip.text.x = element_blank(),
        #strip.text.x = element_text(size = 50),
        #legend.position = c(0.6, 0.2),
        #legend.title = element_text(size = 30),
        #legend.text = element_text(size = 25),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        text = element_text(family = "Osaka"))
  
  #グラフの合成
  #g3 <- grid.arrange(g1,g2,ncol=1)
  
  #g3
  
  #setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/Upside時系列グラフ&FMSY-SQ棒グラフ")
  #ggsave(file = paste(unique(UpsideResult$prefecture)[x],"_時系列&FMSY-SQ棒グラフ",".png"), plot=g3 ,width = 10,height = 14.8)

  
  #グラフを個別に出したい時はこちら
  #g1
  g2
})

```

## シミュレーション結果における、水産加工(食料品)産業維持に必要な漁獲量の過不足量算出

```{r}
#有効数字を999桁に設定
options(scipen=999,digits = 6)

#必要なデータのみを抜き出す（県名とシェア比）
dt.iots <- IOTs %>%
  select(prefecture = 県名,share = 海面漁業生産額における水産食料品の占める割合)

#維持する基準のなる2015年の各県の漁獲量にシェアを掛け、水産加工に流れる・必要とする漁獲量を算出する
dt.standard <- UpsideResult %>%
  filter(year == 2015) %>%
  left_join(dt.iots,by="prefecture") %>%
  summarise(prefecture,share,base_catch_t = total_pref_catch * share)

#基準値の入ったデータフレームをシミュレーション結果に結合していく
dt.comp <- UpsideResult %>%
  filter(year > 2015) %>%
  left_join(dt.standard,by = "prefecture") %>%
  summarise(time = year-2015,
            prefecture,
            alphabet,
            管理シナリオ = ifelse(management == "SQ","現状維持政策",
                            ifelse(management == "FMSY", "MSY漁獲政策", "経済最適化政策")), #図示するときのために名前を変更
            require_catch_t = total_pref_catch * share, #その年に水産食料品に流れる量を算出
            compare_t = require_catch_t - base_catch_t, #その年に水産食料品に流れる量と基準年(2015)に水産食料品が必要とした量の比較
            rate = compare_t/base_catch_t, #過不足量が基準年(2015)に水産食料品が必要とした量と比べてどのくらいの比率なのか。
            management) %>%
  na.omit()

#算出できた県の数を確認
unique(dt.comp$alphabet)

```

## 過不足量の図示(比率)

```{r}
#lapplyでloopをまわす
lapply(1:length(unique(dt.comp$alphabet)), function(x){
  
  ggdata <- dt.comp %>%
    filter(alphabet == unique(dt.comp$alphabet)[x],
           管理シナリオ %in% c("現状維持政策","MSY漁獲政策")) 
  
  ggplot(ggdata,aes(x = time,y = rate, fill = 管理シナリオ)) +
  theme_hc(base_family = "HiraKakuPro-W3")+
  theme(
    axis.text=element_text(size=10),
    axis.title=element_text(size=13,face="bold")
  ) +
  labs(x="年",
       y="過不足量比",
       title = paste(unique(dt.comp$prefecture)[x],"における2015年の水産食料品産業の海面漁業への需要量\nに対する各年の漁獲量の過不足量の比"),sep="") +
  scale_fill_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800")) +
  geom_bar(stat = "identity",position = "dodge")+
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),
                   fill = "gray", alpha = 0.01)
  
  #グラフの保存
  #setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/過不足量の時系列")
  #ggsave(file = paste(unique(ggdata$prefecture),"_過不足漁獲量","_時系列",".png", sep = ""),width = 7.4,height = 5)
})

#y軸を割合にする
lapply(1:length(unique(dt.comp$alphabet)), function(x){
  
  ggdata <- dt.comp %>%
    filter(alphabet == unique(dt.comp$alphabet)[x],
           管理シナリオ %in% c("現状維持政策","MSY漁獲政策"))
  
  ggplot(ggdata,aes(x = time,y = rate, fill = 管理シナリオ)) +
  theme_light(base_family = "Osaka")+
  theme(
    axis.text=element_text(size=10),
    axis.title=element_text(size=13,face="bold"),
    plot.title = element_text(hjust = 0.5)
  ) +
  labs(x="年",
       y="過不足量割合",
       title = paste(unique(dt.comp$prefecture)[x],"における2015年の水産食料品産業の海面漁業への需要量\nに対する各年の漁獲量の過不足量(t)の割合"),sep="") +
  scale_fill_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800")) +
  geom_bar(stat = "identity",position = "dodge")+
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),
                   fill = "gray", alpha = 0.01)
  
  #setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/過不足量の時系列_割合")
  #ggsave(file = paste(unique(ggdata$prefecture),"_過不足漁獲量","_時系列_割合",".png", sep = ""),width = 7.4,height = 5)
})


#### 移動平均の折れ線グラフを作成 ####
lapply(1:length(unique(dt.comp$alphabet)), function(x){
  
  #特定の県を指定
  dt.graph <- dt.comp %>%
    filter(prefecture == unique(dt.comp$prefecture)[x] &
           #year > 2015 &
           管理シナリオ %in% c("SQ","FMSY")) %>%
    group_by(管理シナリオ) %>%
    summarise(prefecture,
              年 = time,
              compare_moving_mean5 = rollmean(rate, k = 5, fill = NA),
              compare_moving_mean10 = rollmean(rate, k = 10, fill = NA),
              compare_moving_mean15 = rollmean(rate, k = 15, fill = NA),
              compare_moving_mean20 = rollmean(rate, k = 20, fill = NA)) %>%
    ungroup()
  
  #図示
  #5年移動平均
 g1 <- ggplot(dt.graph,aes(x = 年, y = compare_moving_mean5,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"漁業から水産食料品産業への過不足供給量の割合の5年移動平均"),
  　     subtitle = "2015のシェアで2015年と比較",
  　     x = "年数",
    　   y = "割合") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 48),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
 
  #10年移動平均
 g2 <- ggplot(dt.graph,aes(x = 年, y = compare_moving_mean10,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"漁業から水産食料品産業への過不足供給量の割合の10年移動平均"),
  　     subtitle = "2015のシェアで2015年と比較",
  　     x = "年数",
    　   y = "割合") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 45),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
 　#15年移動平均
  g3 <- ggplot(dt.graph,aes(x = 年, y = compare_moving_mean15,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"漁業から水産食料品産業への過不足供給量の割合の15年移動平均"),
  　     subtitle = "2015のシェアで2015年と比較",
  　     x = "年数",
    　   y = "割合") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 43),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  #20年移動平均
  g4 <- ggplot(dt.graph,aes(x = 年, y = compare_moving_mean20,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"漁業から水産食料品産業への過不足供給量の割合の20年移動平均"),
  　     subtitle = "2015のシェアで2015年と比較",
  　     x = "年数",
    　   y = "割合") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 40),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/移動平均")
  ggsave(plot = g1,file = paste(unique(dt.graph$prefecture),"_過不足漁獲量","_5年移動平均",".png", sep = ""),width = 7.4,height = 5)
  ggsave(plot = g2,file = paste(unique(dt.graph$prefecture),"_過不足漁獲量","_10年移動平均",".png", sep = ""),width = 7.4,height = 5)
  ggsave(plot = g3,file = paste(unique(dt.graph$prefecture),"_過不足漁獲量","_15年移動平均",".png", sep = ""),width = 7.4,height = 5)
  ggsave(plot = g4,file = paste(unique(dt.graph$prefecture),"_過不足漁獲量","_20年移動平均",".png", sep = ""),width = 7.4,height = 5)
  
  #作成・保存するグラフが複数のため、それぞれオブジェトに格納する必要がある。従って、表示するためにはい可能様にする必要がある。
  return(list(g1,g2,g3,g4))
  
})


```

## 波及効果の算出

```{r}
#総効果を入れる枠組み作り(単位は100万円)
HakyuSoukouka <- data.frame(
  prefecture = IOTs$県名,
  TotalEffect = NA
)

#経済波及効果算出コードを読み込む
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Other/産業連関表/For_Analysis")

#岩手県
source("IwateEconomicRippleEffect.R")
#宮城県
source("MiyagiEconomicRippleEffect.R")

#岩手の水産食料品産業の波及効果を算出(単位は100万円)
IwateHakyu <- IwateEconomicRippleEffect(Demand_million_yen = 59723,"水産食料品")

#合計値(列和)を抽出
IwateHakyu_total <- lapply(IwateHakyu[-1],sum,na.rm = T)



#宮城の水産食料品産業の波及効果を算出(単位は100万円)
MiyagiHakyu <- MiyagiEconomicRippleEffect(Demand_million_yen = 223800,"水産食料品")

#合計値(列和)を抽出
MiyagiHakyu_total <- lapply(MiyagiHakyu[-1],sum,na.rm = T)


#総効果を抽出(単位は100万円)し、枠組みに格納
HakyuSoukouka[HakyuSoukouka$prefecture=="岩手",2] <- IwateHakyu_total[["総効果生産誘発額"]]
HakyuSoukouka[HakyuSoukouka$prefecture=="宮城",2] <- MiyagiHakyu_total[["総効果生産誘発額"]]

```

## シミュレーション結果における、水産加工(食料品)産業維持に必要な漁獲量の過不足量が与える経済波及効果の算出

```{r}
#有効数字を999桁に設定
options(scipen=999,digits = 5)

#NPVを求める際の割引率を指定
DiscountRate <- 0.05

#過不足比率に経済波及効果を掛ける。dt.ere = data.economic ripple effect
dt.ere <- dt.comp %>%
  left_join(HakyuSoukouka,by="prefecture") %>%
  group_by(prefecture,管理シナリオ) %>%
  mutate(Effect = rate * TotalEffect,
         NPV = Effect/((1+DiscountRate)^(time-1)),
         TotalPrefNPV = sum(NPV),
         RollingAverage5 = rollmean(NPV,k=5,fill=NA),
         RollingAverage10 = rollmean(NPV,k=10,fill=NA),
         RollingAverage15 = rollmean(NPV,k=15,fill=NA),
         RollingAverage20 = rollmean(NPV,k=20,fill=NA)
         ) %>%
  filter(!is.na(Effect))

```

## 過不足量が与える経済波及効果の図示(NPV棒グラフ・移動平均)

```{r}
#水産食料品データが存在する県のみでループ作図していく
lapply(1:length(unique(dt.ere$prefecture)), function(x){
  
  
  dt.ere %<>% #関数内は別環境なので直接的な書き換えを行っても大丈夫
    filter(prefecture == unique(dt.ere$prefecture)[x],
           管理シナリオ %in% c("SQ","FMSY")) 
  
　#わかりやすく時系列で見て見る
　#ggplot(dt.ere,aes(x = time,y = Effect,fill = 管理シナリオ)) +
  #　geom_bar(stat = "identity",position = "dodge") +
  #　scale_fill_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))

　###  NPVの期間内合計値を見てみる  ###
　dt.npv <- dt.ere %>%
  　select(prefecture,alphabet,管理シナリオ,TotalPrefNPV) %>%
  　unique()

　g1 <- ggplot(dt.npv,aes(x = prefecture,y = TotalPrefNPV,fill = 管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_bar(stat = "identity",position = "dodge") +
  　labs(title = paste(unique(dt.ere$prefecture),"における水産食料品作業への過不足供給量が与える合計経済波及効果"),
  　     x = "都道府県名",
    　   y = "合計割引現在価値(100万円)") +
  　scale_fill_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))

  
  ###  NPVの移動平均を見てみる  ###
 g2 <- ggplot(dt.ere,aes(x = time, y = RollingAverage5,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.ere$prefecture),"における水産食料品作業への過不足供給量\nが与える経済波及効果_5年移動平均"),
  　     x = "年数",
    　   y = "合計割引現在価値(100万円)") +
    geom_text_repel(
      data = subset(dt.ere, time == 48),
      aes(label = 管理シナリオ),
      vjust = 2,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  g3 <- ggplot(dt.ere,aes(x = time, y = RollingAverage10,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.ere$prefecture),"における水産食料品作業への過不足供給量\nが与える経済波及効果_10年移動平均"),
  　     x = "年数",
    　   y = "合計割引現在価値(100万円)") +
    geom_text_repel(
      data = subset(dt.ere, time == 45),
      aes(label = 管理シナリオ),
      vjust = 2,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  g4 <- ggplot(dt.ere,aes(x = time, y = RollingAverage15,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.ere$prefecture),"における水産食料品作業への過不足供給量\nが与える経済波及効果_15年移動平均"),
  　     x = "年数",
    　   y = "合計割引現在価値(100万円)") +
    geom_text_repel(
      data = subset(dt.ere, time == 43),
      aes(label = 管理シナリオ),
      vjust = 2,
      #hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  
  g5 <- ggplot(dt.ere,aes(x = time, y = RollingAverage20,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.ere$prefecture),"における水産食料品作業への過不足供給量\nが与える経済波及効果_20年移動平均"),
  　     x = "年数",
    　   y = "合計割引現在価値(100万円)") +
    geom_text_repel(
      data = subset(dt.ere, time == 40),
      aes(label = 管理シナリオ),
      vjust = 2,
      hjust = -0.5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none",
          plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))

  
  #グラフの保存
  #setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/経済波及効果(NPV)合計&移動平均")
  #ggsave(plot = g1,file = paste(unique(dt.ere$prefecture),"_経済波及効果","_合計",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g2,file = paste(unique(dt.ere$prefecture),"_経済波及効果","_5年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g3,file = paste(unique(dt.ere$prefecture),"_経済波及効果","_10年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g4,file = paste(unique(dt.ere$prefecture),"_経済波及効果","_15年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g5,file = paste(unique(dt.ere$prefecture),"_経済波及効果","_20年移動平均",".png", sep = ""),width = 7.4,height = 5)
  
  return(list(g1,g2,g3,g4,g5))
  
  })
```

## 漁獲量の移動平均

```{r}
#Upsideの結果を移動平均にしてみる
lapply(1:length(unique(UpsideResult$prefecture)),function(x){
  
  #特定の県を指定
  dt.graph <- UpsideResult %>%
    filter(prefecture == unique(UpsideResult$prefecture)[x] &
           year > 2015 &
           management %in% c("SQ","FMSY")) %>%
    group_by(management) %>%
    summarise(prefecture,
              管理シナリオ = management,
              年 = year-2015,
              total_pref_catch_moving_mean5 = rollmean(total_pref_catch, k = 5, fill = NA),
              total_pref_catch_moving_mean10 = rollmean(total_pref_catch, k = 10, fill = NA),
              total_pref_catch_moving_mean15 = rollmean(total_pref_catch, k = 15, fill = NA),
              total_pref_catch_moving_mean20 = rollmean(total_pref_catch, k = 20, fill = NA)) %>%
    ungroup()
  
  #図示
 g1 <- ggplot(dt.graph,aes(x = 年, y = total_pref_catch_moving_mean5,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"の漁獲量の5年移動平均"),
  　     x = "年数",
    　   y = "漁獲量(t)") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 48),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none") +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
 
 g2 <- ggplot(dt.graph,aes(x = 年, y = total_pref_catch_moving_mean10,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"の漁獲量の10年移動平均"),
  　     x = "年数",
    　   y = "漁獲量(t)") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 45),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none") +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  g3 <- ggplot(dt.graph,aes(x = 年, y = total_pref_catch_moving_mean15,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"の漁獲量の15年移動平均"),
  　     x = "年数",
    　   y = "漁獲量(t)") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 43),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none") +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))
  
  g4 <- ggplot(dt.graph,aes(x = 年, y = total_pref_catch_moving_mean20,col=管理シナリオ)) +
  　theme_light(base_family = "Osaka") +
  　geom_line() +
  　labs(title = paste(unique(dt.graph$prefecture),"の漁獲量の20年移動平均"),
  　     x = "年数",
    　   y = "漁獲量(t)") +
    geom_text_repel(
      data = subset(dt.graph, 年 == 40),
      aes(label = 管理シナリオ),
      vjust = 1,
      #hjust = -5,
      segment.color = NA
    ) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#a9a9a9",fill = "#a9a9a9", alpha = 0.009) +
    theme(legend.position = "none") +
  　scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","econOpt"="#0041ff"))

  
  #グラフの保存
  #setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-U.Iwate/Outputs/UpsidePrefAnalysisOutput/漁獲量の移動平均")
  
  #ggsave(plot = g1,file = paste(unique(dt.graph$prefecture),"_漁獲量","_5年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g2,file = paste(unique(dt.graph$prefecture),"_漁獲量","_10年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g3,file = paste(unique(dt.graph$prefecture),"_漁獲量","_15年移動平均",".png", sep = ""),width = 7.4,height = 5)
  #ggsave(plot = g4,file = paste(unique(dt.graph$prefecture),"_漁獲量","_20年移動平均",".png", sep = ""),width = 7.4,height = 5)
  return(list(g1,g2,g3,g4))
})


```

## 資源水準別の時系列

```{r}
#不必要なデータを削除
multi_stock_plus2 <- multi_stock_plus %>%
  mutate(fish_stock = paste(fish,stock,sep = "_")) %>%
  select(fish_stock,prefecture,condition)

#Upsideの結果に資源水準情報を追加
UpsideResultDetail2 <- UpsideResultDetail %>%
  left_join(multi_stock_plus2) %>%
  mutate(condition = ifelse(fish_stock == "bluefin_tuna_single_stock","low",condition),
         condition = ifelse(fish_stock == "albacore_tuna_single_stock","medium",condition),
         condition = ifelse(fish_stock == "bigeye_tuna_single_stock","medium",condition),
         condition = ifelse(fish_stock == "yellowfin_tuna_single_stock","medium",condition),
         condition = ifelse(fish_stock == "swordfish_single_stock","high",condition),
         condition = ifelse(fish_stock == "marlin_single_stock","low",condition),
         condition = ifelse(fish_stock == "skipjack_single_stock","high",condition),
         condition = ifelse(fish_stock == "salmon_single_stock","medium",condition),
         condition = ifelse(fish_stock == "trout_single_stock","low",condition),
         condition = ifelse(fish_stock == "saury_single_stock","medium",condition),
         condition = ifelse(fish_stock == "yellowtail_single_stock","high",condition))


#岩手県のデータ
dt.graph <- UpsideResultDetail2 %>%
  filter(prefecture == "岩手",management == "Historical") %>%
  group_by(condition,year) %>%
  summarise(prefecture,year,catch_t = sum(pref_catch,na.rm=T),condition = factor(condition,levels = c("high","medium","low","NA"))) %>%
  ungroup() %>%
  unique() %>%
  group_by(year) %>%
  mutate(rate = catch_t/sum(catch_t,na.rm=T)) %>%
  ungroup()

ggplot(dt.graph,aes(x=year,y=rate,fill=condition)) +
  geom_area(size = .1,colour = "black")

```

## 地域の産業・雇用創造チャート(拡大図入り)
地域における各産業のポジションを明らかにする。具体的には、中村良平（岡山大）が考案した横軸を稼ぐ力（修正特化係数の対数値）、縦軸を雇用力（従業者割合）で示したグラフを作成する。

しかしながら、本人が留意事項として、「第一次産業の修正特化係数は実態との乖離が大きくなりがちな点」と述べており、漁業に使うことがためらわれるので、今回は不採用とした。


```{r}
IOTs_Iwate2 <- IOTs_Iwate %>%
  select(産業種類,産業名,対数変換した修正特化係数,従業員数比率) %>%
  mutate(産業種類 = factor(産業種類,levels = c("第一次産業","第二次産業","第三次産業"))) %>%
  na.omit()

IOTs_Miyagi2 <- IOTs_Miyagi %>%
  select(産業種類,産業名,対数変換した修正特化係数,従業員数比率) %>%
  mutate(産業種類 = factor(産業種類,levels = c("第一次産業","第二次産業","第三次産業"))) %>%
  na.omit()

#岩手県の全産業
base <- ggplot(IOTs_Iwate2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = 産業名))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.12)+
  labs(title = "岩手県", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品","耕種農業","土木","小売","畜産")),#"医療・保健衛生","飲食サービス")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1,
      hjust = 1.2,
      size = 10
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品")),color="red",shape = 2, size = 6)+
  theme(plot.title = element_text(size = 30,face = "bold",hjust = .5),
        legend.position = "none",
        #legend.position = c(0.2, 0.8),
        #legend.title = element_text(size = 20),
        #legend.text = element_text(size = 15),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"))+
  annotate("rect", xmin=-0.05,xmax=0.8, ymin=0,ymax=0.0125,
             fill="#a9a9a9",alpha = .5)

#宮城県の全産業
base <- ggplot(IOTs_Miyagi2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = 産業名))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.12)+
  labs(title = "宮城県", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品","小売","その他の対事業所サービス","飲食サービス","医療","卸売","米","公共事業")),#"医療・保健衛生","飲食サービス")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1,
      hjust = -.5,
      size = 10
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品")),color="red",shape = 2, size = 6)+
  theme(plot.title = element_text(size = 30,face = "bold",hjust = .5),
        legend.position = "none",
        #legend.position = c(0.2, 0.8),
        #legend.title = element_text(size = 20),
        #legend.text = element_text(size = 15),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"))+
  annotate("rect", xmin=0.3,xmax=0.65, ymin=0,ymax=0.028,
             fill="#a9a9a9",alpha = .5)

#岩手県のフォーカス
add <- ggplot(IOTs_Iwate2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = 産業名))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size =4)+
  ylim(0,0.0125)+
  xlim(-0.05,0.8)+
  labs(title = "灰色部分の拡大図", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品","林業","自動車","農業サービス","セメント・セメント製品","その他の電子部品","食肉・畜産食料品","木材・木製品","その他の非営利団体サービス","生産用機械")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = 2,
      hjust = -0.25,
      size = 6
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品")),color="red",shape=2,size=6)+
  theme(plot.title = element_text(size = 25,face = "bold",hjust = .5),
        #plot.title.position = element_blank(),
        legend.position = "none",
        axis.title=element_blank(),
        panel.background = element_rect(fill = "#dcdcdc"),
        plot.background = element_rect(fill = "#dcdcdc", colour = "black"),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey'))


add2 <- ggplotGrob(add)
a <- base + annotation_custom(add2,xmin = -3,xmax = -.35,ymin = 0.025,ymax = 0.125)
a



#宮城県のフォーカス
add <- ggplot(IOTs_Miyagi2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = 産業名))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.028)+
  xlim(0.29,0.65)+
  labs(title = "灰色部分の拡大図", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品","米","その他の電子部品","その他の土木建設","飼料・有機質肥料（別掲を除く。）","パルプ・紙・板紙・加工紙","建設補修")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1.2,
      hjust = -.2,
      size = 6
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品")),color="red",shape=2,size=6)+
  theme(plot.title = element_text(size = 25,face = "bold",hjust = .5),
        #plot.title.position = element_blank(),
        legend.position = "none",
        axis.title=element_blank(),
        panel.background = element_rect(fill = "#dcdcdc"),
        plot.background = element_rect(fill = "#dcdcdc", colour = "black"),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey'))


add2 <- ggplotGrob(add)
a <- base + annotation_custom(add2,xmin = -1.2,xmax = -.2,ymin = 0.02,ymax = 0.125)
a

```

## English version：地域の産業・雇用創造チャート(拡大図入り)

```{r}
IOTs_Iwate2 <- IOTs_Iwate %>%
  select(産業種類,Industrial_Classification,産業名,対数変換した修正特化係数,従業員数比率) %>%
  mutate(産業種類 = factor(産業種類,levels = c("第一次産業","第二次産業","第三次産業"))) %>%
  na.omit(対数変換した修正特化係数)

IOTs_Miyagi2 <- IOTs_Miyagi %>%
  select(産業種類,Industrial_Classification,産業名,対数変換した修正特化係数,従業員数比率) %>%
  mutate(産業種類 = factor(産業種類,levels = c("第一次産業","第二次産業","第三次産業"))) %>%
  na.omit()

#岩手県の全産業
base <- ggplot(IOTs_Iwate2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = Industrial_Classification))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.12)+
  labs(title = "Iwate", x = "Logarithmically transformed correction specialization multiplier", y = "Percentage of employees")+
  geom_text_repel(
      data = subset(IOTs_Iwate2, Industrial_Classification %in% c("Fisheries","Seafood Products","Agriculture","Civil engineering","Retail","Livestock")),#"医療・保健衛生","飲食サービス")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1,
      hjust = 1.2,
      size = 10
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品")),color="red",shape = 2, size = 6)+
  theme(plot.title = element_text(size = 30,face = "bold",hjust = .5),
        legend.position = "none",
        #legend.position = c(0.2, 0.8),
        #legend.title = element_text(size = 20),
        #legend.text = element_text(size = 15),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"))+
  annotate("rect", xmin=-0.05,xmax=0.8, ymin=0,ymax=0.0125,
             fill="#a9a9a9",alpha = .5)

#宮城県の全産業
base <- ggplot(IOTs_Miyagi2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = Industrial_Classification))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.12)+
  labs(title = "Miyagi", x = "Logarithmically transformed correction specialization multiplier", y = "Percentage of employees")+
  geom_text_repel(
      data = subset(IOTs_Miyagi2, Industrial_Classification %in% c("Fisheries","Seafood Products","Retail","Other business services","Food and beverage service","Medical","Wholesale","Rice","Public works")),#"医療・保健衛生","飲食サービス")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1,
      hjust = -.5,
      size = 10
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品")),color="red",shape = 2, size = 6)+
  theme(plot.title = element_text(size = 30,face = "bold",hjust = .5),
        legend.position = "none",
        #legend.position = c(0.2, 0.8),
        #legend.title = element_text(size = 20),
        #legend.text = element_text(size = 15),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=20,face="bold"))+
  annotate("rect", xmin=0.3,xmax=0.65, ymin=0,ymax=0.028,
             fill="#a9a9a9",alpha = .5)

#岩手県のフォーカス
add <- ggplot(IOTs_Iwate2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = Industrial_Classification))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size =4)+
  ylim(0,0.0125)+
  xlim(-0.05,0.8)+
  labs(title = "Enlarged view of the gray part", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Iwate2, Industrial_Classification %in% c("Fisheries","Seafood Products","Forestry","Automobile","Agricultural services","Cement / Cement products","Other electronic components","Meat / Meat products","Wood / Wood products","Other non-profit services")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = 2,
      hjust = -0.25,
      size = 6
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Iwate2, 産業名 %in% c("水産業","水産食料品")),color="red",shape=2,size=6)+
  theme(plot.title = element_text(size = 25,face = "bold",hjust = .5),
        #plot.title.position = element_blank(),
        legend.position = "none",
        axis.title=element_blank(),
        panel.background = element_rect(fill = "#dcdcdc"),
        plot.background = element_rect(fill = "#dcdcdc", colour = "black"),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey'))


add2 <- ggplotGrob(add)
a <- base + annotation_custom(add2,xmin = -3,xmax = -.5,ymin = 0.025,ymax = 0.125)
a



#宮城県のフォーカス
add <- ggplot(IOTs_Miyagi2,aes(x=対数変換した修正特化係数,y=従業員数比率,label = Industrial_Classification))+
  theme_light(base_family = "HiraKakuPro-W3")+
  geom_point(aes(color = 産業種類),size = 4)+
  ylim(0,0.028)+
  xlim(0.29,0.65)+
  labs(title = "Enlarged view of the gray part", x = "対数変換した修正特化係数", y = "従業員数比率")+
  geom_text_repel(
      data = subset(IOTs_Miyagi2, Industrial_Classification %in% c("Fisheries","Seafood Products","Rice","Other electronic components","Other civil engineering","Feed / organic fertilizer","Pulp / paper / paperboard / processed paper","Construction repair")),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1.2,
      hjust = -.2,
      size = 6
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")+
  geom_point(data = subset(IOTs_Miyagi2, 産業名 %in% c("漁業","水産食料品")),color="red",shape=2,size=6)+
  theme(plot.title = element_text(size = 25,face = "bold",hjust = .5),
        #plot.title.position = element_blank(),
        legend.position = "none",
        axis.title=element_blank(),
        panel.background = element_rect(fill = "#dcdcdc"),
        plot.background = element_rect(fill = "#dcdcdc", colour = "black"),
        panel.grid.major = element_line(color = 'grey'),
        panel.grid.minor = element_line(color = 'grey'))


add2 <- ggplotGrob(add)
a <- base + annotation_custom(add2,xmin = -1.2,xmax = -.2,ymin = 0.02,ymax = 0.125)
a

```

## 総務省統計局に置いてあった修正特化係数を用いてチャート作り

```{r}
修正特化係数 <- as.numeric(TokkaKeisu)
従業員比率 <- as.numeric(t(Jugyouin[3,-c(1,2)]))
data3 <- cbind(修正特化係数,従業員比率)
names(data3) <- c("修正特化係数","従業比率")
str(data3)
ggplot()+
  theme_light(base_family = "HiraKakuPro-W3") +
  labs(title = "岩手県",x="修正特化係数",y="従業比率") +
  geom_point(aes(x=TokkaKeisu$岩手県,y=Jugyouin$岩手県))+
  geom_text_repel(
      data = subset(TokkaKeisu,  colnames(TokkaKeisu) == "岩手県"),
      aes(fontface = "bold",
          family = "HiraKakuPro-W3"),
      box.padding = .5,
      vjust = -1,
      hjust = .5,
      size = 7
    )+
  geom_vline(aes(xintercept=0),color="black",linetype="dashed")+
  geom_hline(aes(yintercept=0),color="black",linetype="dashed")



```

## 経済波及効果

```{r}
#経済波及効果の倍率の算出。投入する値を1にすることで経済波及効果の倍率を算出できる。
IwateHakyu <- IwateEconomicRippleEffect(Demand_million_yen = 10000,"水産業")
IwateHakyu_total <- lapply(IwateHakyu[-1],sum,na.rm = T)
Iwate_multiplier <- IwateHakyu_total[["総効果生産誘発額"]]

MiyagiHakyu <- MiyagiEconomicRippleEffect(Demand_million_yen = 1,"漁業")
MiyagiHakyu_total <- lapply(MiyagiHakyu[-1],sum,na.rm = T)
Miyagi_multiplier <- MiyagiHakyu_total[["総効果生産誘発額"]]

#水産食料品の倍率も算出する
IwateHakyu <- IwateEconomicRippleEffect(Demand_million_yen = 1,"水産食料品")
IwateHakyu_total <- lapply(IwateHakyu[-1],sum,na.rm = T)
Iwate_multiplier_processing <- IwateHakyu_total[["総効果生産誘発額"]]

MiyagiHakyu <- MiyagiEconomicRippleEffect(Demand_million_yen = 1,"水産食料品")
MiyagiHakyu_total <- lapply(MiyagiHakyu[-1],sum,na.rm = T)
Miyagi_multiplier_processing <- MiyagiHakyu_total[["総効果生産誘発額"]]

```

## <学会誌> 過去漁獲量とシミュレーション結果による将来漁獲量を合わせたグラフ

```{r}
#指数表現を避けるために設定
options(scipen=1000)

b <- UpsideResult %>%
  filter(alphabet %in% c("iwate","miyagi")) %>%
  filter(management %in% c("FMSY","SQ","Historical")) %>%
  mutate(alphabet = ifelse(alphabet == "iwate","Iwate","Miyagi"),
         Management = factor(management,levels = c("SQ","FMSY","Historical")),
         total_pref_catch = total_pref_catch/10000)



#修正案１(修正箇所：x軸,y軸,ハイライト追加)
#開始年と終了年は軸から除くべきではないと判断。また、シミュレーション開始年である2015年も除くべきではないと判断したので、等間隔ではなくなるが、最初だけ9年間隔、残りを10年間隔で表現。
ggplot(b,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  labs(y="Annual Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = c(0.1, 0.8),
        strip.text.x = element_text(size = 30))+
  geom_line(size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=0,ymax=Inf,
             fill="#a9a9a9",alpha = .3)



#修正案２（修正箇所：x軸,y軸,ハイライト追加,拡大図追加）
#facetを用いた図に個別に拡大図を入れることができないので、facetを使わずに別々に作成し、外部で合成する。

####  岩手県の場合  ####
#岩手県のデータを抽出
b1 <- filter(b,alphabet == "Iwate")

#ベースとなるプロットを作成
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Iwate",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = "top",
        legend.background = element_rect(colour = "black"),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 20,face = "bold"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=7.5,ymax=12,
             fill="#a9a9a9",alpha = .3)

#拡大図用データ
b2 <- b %>%
  filter(year > 2015,alphabet=="Iwate")

#拡大図の作成
add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",
       y="Catch (10000t)",
       x="Year") +
  ylim(7,12)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 12,face = "bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 12,face = "bold"),
        axis.title.y=element_text(size = 12,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

#ベースとなるプロットに拡大図を載せる
add2 <- ggplotGrob(add)
iwate <- base + annotation_custom(add2,xmin = 2002,xmax = 2068,ymin = 16,ymax = 53)

#保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "IwateTimeseries.png",plot = iwate,dpi = 350, width = 4.8, height = 5.5)




####  宮城県の場合  ####
#宮城県のデータを抽出
b1 <- filter(b,alphabet == "Miyagi")

#ベースとなるプロットを作成
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Miyagi",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = "none",
        plot.title = element_text(hjust = .5),
        title = element_text(size = 20,face = "bold"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=12,ymax=20,
             fill="#a9a9a9",alpha = .3)

#拡大図用のデータ
b2 <- b %>%
  filter(year > 2015,alphabet=="Miyagi")

#拡大図の作成
add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(12,20)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 12,face = "bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 12,face = "bold"),
        axis.title.y=element_text(size = 12,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

#ベースとなるプロットに拡大図を載せる
add2 <- ggplotGrob(add)
miyagi <- base + annotation_custom(add2,xmin = 2002,xmax = 2068,ymin = 25,ymax = 62)

#保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "MiyagiTimeseries.png",plot = miyagi,dpi = 350, width = 4.8, height = 5.5)



#修正案３（岩手県・宮城県を個別に作成）
b1 <- filter(b,alphabet == "Iwate")

base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Iwate",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=15,face="bold"),
        legend.position = "top",
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 15,face = "bold"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=7.5,ymax=12,
             fill="#a9a9a9",alpha = .3)

#拡大図用
b2 <- b %>%
  filter(year > 2015,alphabet=="Iwate")

add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(7,12)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=10,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 8,face = "bold"),
        axis.text.y = element_text(size = 8,face = "bold"),
        axis.title.x = element_text(size = 10,face = "bold"),
        axis.title.y=element_text(size = 10,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

add2 <- ggplotGrob(add)
iwate <- base + annotation_custom(add2,xmin = 2012,xmax = 2068,ymin = 15,ymax = 56)

iwate

setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "IwateTimeseries2.png",plot = iwate,dpi = 350, width = 4.5, height = 4.5)



#宮城県の場合
b1 <- filter(b,alphabet == "Miyagi")
  
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Miyagi",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=15,face="bold"),
        legend.position = "top",
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 15,face = "bold"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=12,ymax=20,
             fill="#a9a9a9",alpha = .3)

b2 <- b %>%
  filter(year > 2015,alphabet=="Miyagi")

add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(12,20)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=10,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 8,face = "bold"),
        axis.text.y = element_text(size = 8,face = "bold"),
        axis.title.x = element_text(size = 10,face = "bold"),
        axis.title.y=element_text(size = 10,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

add2 <- ggplotGrob(add)
miyagi <- base + annotation_custom(add2,xmin = 2012,xmax = 2068,ymin = 21,ymax = 62)

miyagi

setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "MiyagiTimeseries2.png",plot = miyagi,dpi = 350, width = 4.5, height = 4.5)



``` 

## <学会誌>移動平均で示す2015年との原料割合の比較（※グラフの数値は供給割合ではなく、2015年との比較した値である）

```{r}
#特定の県を指定
  dt.graph <- dt.comp %>%
    filter(alphabet %in% c("iwate","miyagi") &
           #year > 2015 &
           management %in% c("SQ","FMSY")) %>%
    group_by(管理シナリオ,prefecture) %>%
    summarise(alphabet,
              Time = time,
              rate,
              Management = management,
              compare_moving_mean5 = rollmean(rate, k = 5, fill = NA),
              compare_moving_mean10 = rollmean(rate, k = 10, fill = NA),
              compare_moving_mean15 = rollmean(rate, k = 15, fill = NA),
              compare_moving_mean20 = rollmean(rate, k = 20, fill = NA)) %>%
    ungroup() %>%
    mutate(alphabet = ifelse(alphabet == "iwate","Iwate","Miyagi"))
  
  #移動平均の年数ごとにデータを分割し、年数を付与して統合
  dt.ere1 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = rate,Management) %>%
    mutate(Type = "Time series") 
  dt.ere10 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = compare_moving_mean10,Management) %>%
    mutate(Type = "10 years") 
  dt.ere20 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = compare_moving_mean20,Management) %>%
    mutate(Type = "20 years")
  #食料品製造業用設備の法定耐用年数は10年、阿部長からのヒアリングだと20年が実際の耐用年数
  dt.stack <- rbind(dt.ere1,dt.ere10,dt.ere20)


　#移動平均でfacetを使うため、県は手動で分ける
  dt.stack1 <- filter(dt.stack,alphabet == "Iwate")
  dt.stack2 <- filter(dt.stack,alphabet == "Miyagi")
  
  #岩手県の場合
  gg1 <- ggplot(dt.stack1,aes(x = Time, y = moving, fill=Management)) +
  　theme_hc(base_family = "Osaka") +
  　geom_bar(stat = "identity",position = "dodge") +
  　labs(title = "Iwate",
  　     x = "Time",
    　   y = "Ratio") +
    facet_wrap(~factor(Type,levels = c("Time series","10 years","20 years"))) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#c7c7c7",fill = "#c7c7c7", alpha = 0.009) +
    theme(
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 20),
        legend.position = "top",
        legend.title = element_text(size = 15,face="bold"),
        legend.text = element_text(size = 12),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        plot.title = element_text(hjust = 0.5,face = "bold",size = 20),
        plot.subtitle = element_text(hjust = 0.5)) +
  　scale_fill_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800"))
  
  gg1
  
  #保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/移動平均で示す原料供給割合")
ggsave(file = "Iwate.png",plot = gg1,dpi = 350)
  


　#宮城県の場合
gg2 <- ggplot(dt.stack2,aes(x = Time, y = moving, fill=Management)) +
  　theme_hc(base_family = "Osaka") +
  　geom_bar(stat = "identity",position = "dodge") +
  　labs(title = "Miyagi",
  　     x = "Time",
    　   y = "Ratio") +
    facet_wrap(~factor(Type,levels = c("Time series","10 years","20 years"))) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#c7c7c7",fill = "#c7c7c7", alpha = 0.009) +
    theme(
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 20),
        legend.position = "top",
        legend.title = element_text(size = 15,face="bold"),
        legend.text = element_text(size = 12),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        plot.title = element_text(hjust = 0.5,face = "bold",size = 20),
        plot.subtitle = element_text(hjust = 0.5)) +
  　scale_fill_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800"))

   gg2

  #保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/移動平均で示す原料供給割合")
ggsave(file = "Miyagi.png",plot = gg2,dpi = 350,width = 7.29,height = 4.51)
```

## (仮)魚種別の結果

```{r}
#岩手の沿岸漁業ー令和２年度ーより
#サンマ・イカ・サケマス類の冷凍水産物が多いらしい
#水産物流通統計調査ー水産加工統計調査ーより
#サケマス類・イワシ類・サバ類・サンマ・タラ類・イカ類が多い

target_fish <- c("salmon_single_stock","japanese_anchovy_pacific_stock","japanese_sardine_pacific_stock","mackerel_pacific_stock","saury_single_stock","cod_pacific_north_stock","japanese_common_squid_winter_stock")

UpsideResultDetail_target_fish <- UpsideResultDetail %>%
  filter(prefecture == "岩手",management %in% c("Historical","SQ","FMSY"),fish_stock %in% target_fish)

lapply(1:length(target_fish), function(x){
  data <- UpsideResultDetail_target_fish %>%
    filter(fish_stock == target_fish[x])
  
  ggplot(data,aes(x=year,y=pref_catch,col=management))+
    geom_line() +
    ggtitle(paste(target_fish[x]))+
    scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray"))
})
```

## <卒論用> 過去漁獲量とシミュレーション結果による将来漁獲量を合わせたグラフ

```{r}
#指数表現を避けるために設定
options(scipen=1000)

b <- UpsideResult %>%
  filter(alphabet %in% c("iwate","miyagi")) %>%
  filter(management %in% c("FMSY","SQ","Historical")) %>%
  mutate(alphabet = ifelse(alphabet == "iwate","Iwate","Miyagi"),
         management = ifelse(management == "SQ","現状維持政策",
                             ifelse(management == "FMSY","MSY漁獲政策","過去漁獲量")),
         Management = factor(management,levels = c("現状維持政策","MSY漁獲政策","過去漁獲量")),
         total_pref_catch = total_pref_catch/10000)



#修正案１(修正箇所：x軸,y軸,ハイライト追加)
#開始年と終了年は軸から除くべきではないと判断。また、シミュレーション開始年である2015年も除くべきではないと判断したので、等間隔ではなくなるが、最初だけ9年間隔、残りを10年間隔で表現。
ggplot(b,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  labs(y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = c(0.1, 0.8),
        strip.text.x = element_text(size = 30))+
  geom_line(size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=0,ymax=Inf,
             fill="#a9a9a9",alpha = .3)



#修正案２（修正箇所：x軸,y軸,ハイライト追加,拡大図追加）
#facetを用いた図に個別に拡大図を入れることができないので、facetを使わずに別々に作成し、外部で合成する。

####  岩手県の場合  ####
#岩手県のデータを抽出
b1 <- filter(b,alphabet == "Iwate")

#ベースとなるプロットを作成
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Iwate",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = "top",
        legend.background = element_rect(colour = "black"),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 20,face = "bold"),
        text = element_text(family = "Osaka"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=7.5,ymax=12,
             fill="#a9a9a9",alpha = .3)

#拡大図用データ
b2 <- b %>%
  filter(year > 2015,alphabet=="Iwate")

#拡大図の作成
add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",
       y="Catch (10000t)",
       x="Year") +
  ylim(7,12)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 12,face = "bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 12,face = "bold"),
        axis.title.y=element_text(size = 12,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

#ベースとなるプロットに拡大図を載せる
add2 <- ggplotGrob(add)
iwate <- base + annotation_custom(add2,xmin = 2002,xmax = 2068,ymin = 16,ymax = 53)

#保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "IwateTimeseries.png",plot = iwate,dpi = 350, width = 4.8, height = 5.5)




####  宮城県の場合  ####
#宮城県のデータを抽出
b1 <- filter(b,alphabet == "Miyagi")

#ベースとなるプロットを作成
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Miyagi",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = "none",
        plot.title = element_text(hjust = .5),
        title = element_text(size = 20,face = "bold"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=12,ymax=20,
             fill="#a9a9a9",alpha = .3)

#拡大図用のデータ
b2 <- b %>%
  filter(year > 2015,alphabet=="Miyagi")

#拡大図の作成
add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(12,20)+
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800","Historical"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 12,face = "bold"),
        axis.text.y = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 12,face = "bold"),
        axis.title.y=element_text(size = 12,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

#ベースとなるプロットに拡大図を載せる
add2 <- ggplotGrob(add)
miyagi <- base + annotation_custom(add2,xmin = 2002,xmax = 2068,ymin = 25,ymax = 62)

#保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "MiyagiTimeseries.png",plot = miyagi,dpi = 350, width = 4.8, height = 5.5)



#修正案３（岩手県・宮城県を個別に作成）
b1 <- filter(b,alphabet == "Iwate")

base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Iwate",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=15,face="bold"),
        legend.position = "top",
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 15,face = "bold"),
        text = element_text(family = "Osaka"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=7.5,ymax=12,
             fill="#a9a9a9",alpha = .3)

#拡大図用
b2 <- b %>%
  filter(year > 2015,alphabet=="Iwate")

add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(8,14)+
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=10,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 8,face = "bold"),
        axis.text.y = element_text(size = 8,face = "bold"),
        axis.title.x = element_text(size = 10,face = "bold"),
        axis.title.y=element_text(size = 10,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5"),
        text = element_text(family = "Osaka")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

add2 <- ggplotGrob(add)
iwate <- base + annotation_custom(add2,xmin = 2012,xmax = 2068,ymin = 15,ymax = 56)

iwate

setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "IwateTimeseries2_jp.png",plot = iwate,dpi = 350, width = 5.5, height = 4.5)



#宮城県の場合
b1 <- filter(b,alphabet == "Miyagi")
  
base <- ggplot(b1,aes(x = year, y = total_pref_catch, color = Management)) +
  theme_bw() +
  scale_x_continuous(breaks = c(1956,1965,1975,1985,1995,2005,2015,2025,2035,2045,2055,2065)) + 
  scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  ylim(0,60)+
  labs(title = "Miyagi",y="Catch (10000t)",x="Year") +
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=12,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=15,face="bold"),
        legend.position = "top",
        legend.title = element_text(size = 10),
        plot.title = element_text(hjust = .5),
        title = element_text(size = 15,face = "bold"),
        text = element_text(family = "Osaka"))+
  geom_line(size=.5)+
  geom_point(aes(shape = Management),size=1.5)+
  annotate("rect", xmin=2016,xmax=2065, ymin=12,ymax=20,
             fill="#a9a9a9",alpha = .3)

b2 <- b %>%
  filter(year > 2015,alphabet=="Miyagi")

add <- ggplot(b2,aes(x=year,y=total_pref_catch,color = Management)) +
  theme_bw() +
  #facet_wrap(~alphabet) +
  scale_x_continuous(breaks = c(2015,2025,2035,2045,2055,2065)) + 
  labs(title = "Enlarged view",y="Catch (10000t)",x="Year") +
  ylim(13,21)+
  scale_color_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800","過去漁獲量"="gray")) +
  theme(axis.text=element_text(size=10,face ="bold"),
        axis.text.x = element_text(angle = 45,hjust = 1,size = 8,face = "bold"),
        axis.text.y = element_text(size = 8,face = "bold"),
        axis.title.x = element_text(size = 10,face = "bold"),
        axis.title.y=element_text(size = 10,face="bold"),
        legend.position = "none",
        plot.title = element_text(face="bold",hjust = 0.5),
        plot.background = element_rect(colour = "black",size=1.2,fill="#f5f5f5"),
        panel.background = element_rect(fill = "#f5f5f5"),
        text = element_text(family = "Osaka")
        )+
  geom_line(size=.5)+
  geom_point(aes(shape=Management),size=1)

add2 <- ggplotGrob(add)
miyagi <- base + annotation_custom(add2,xmin = 2012,xmax = 2068,ymin = 21,ymax = 62)

miyagi

setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/<English> 時系列とシミュレーション結果の混合")
ggsave(file = "MiyagiTimeseries2_jp.png",plot = miyagi,dpi = 350, width = 5.5, height = 4.5)



``` 

## <卒論用>移動平均で示す2015年との原料割合の比較（※グラフの数値は供給割合ではなく、2015年との比較した値である）

```{r}
#特定の県を指定
  dt.graph <- dt.comp %>%
    filter(alphabet %in% c("iwate","miyagi") &
           #year > 2015 &
           management %in% c("SQ","FMSY")) %>%
  　mutate(management = ifelse(management == "SQ","現状維持政策",
                             ifelse(management == "FMSY","MSY漁獲政策","過去漁獲量")),
         Management = factor(management,levels = c("現状維持政策","MSY漁獲政策","過去漁獲量"))) %>%
    group_by(管理シナリオ,prefecture) %>%
    summarise(alphabet,
              Time = time,
              rate,
              Management = management,
              compare_moving_mean5 = rollmean(rate, k = 5, fill = NA),
              compare_moving_mean10 = rollmean(rate, k = 10, fill = NA),
              compare_moving_mean15 = rollmean(rate, k = 15, fill = NA),
              compare_moving_mean20 = rollmean(rate, k = 20, fill = NA)) %>%
    ungroup() %>%
    mutate(alphabet = ifelse(alphabet == "iwate","Iwate","Miyagi"))
  
  #移動平均の年数ごとにデータを分割し、年数を付与して統合
  dt.ere1 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = rate,Management) %>%
    mutate(Type = "Time series") 
  dt.ere10 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = compare_moving_mean10,Management) %>%
    mutate(Type = "10 years") 
  dt.ere20 <- dt.graph %>%
    #filter(管理シナリオ == "FMSY") %>%
    select(Time,alphabet,moving = compare_moving_mean20,Management) %>%
    mutate(Type = "20 years")
  #食料品製造業用設備の法定耐用年数は10年、阿部長からのヒアリングだと20年が実際の耐用年数
  dt.stack <- rbind(dt.ere1,dt.ere10,dt.ere20)


　#移動平均でfacetを使うため、県は手動で分ける
  dt.stack1 <- filter(dt.stack,alphabet == "Iwate")
  dt.stack2 <- filter(dt.stack,alphabet == "Miyagi")
  
  #岩手県の場合
  gg1 <- ggplot(dt.stack1,aes(x = Time, y = moving, fill=Management)) +
  　theme_hc(base_family = "Osaka") +
  　geom_bar(stat = "identity",position = "dodge") +
  　labs(title = "Iwate",
  　     x = "Time",
    　   y = "Ratio") +
    facet_wrap(~factor(Type,levels = c("Time series","10 years","20 years"))) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#c7c7c7",fill = "#c7c7c7", alpha = 0.009) +
    theme(
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 20),
        legend.position = "top",
        legend.title = element_text(size = 15,face="bold"),
        legend.text = element_text(size = 12),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        plot.title = element_text(hjust = 0.5,face = "bold",size = 20),
        plot.subtitle = element_text(hjust = 0.5)) +
  　scale_fill_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800"))
  
  gg1
  
  #保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/移動平均で示す原料供給割合")
ggsave(file = "Iwate_jp.png",plot = gg1,dpi = 350,width = 7.29,height = 4.51)
  


　#宮城県の場合
gg2 <- ggplot(dt.stack2,aes(x = Time, y = moving, fill=Management)) +
  　theme_hc(base_family = "Osaka") +
  　geom_bar(stat = "identity",position = "dodge") +
  　labs(title = "Miyagi",
  　     x = "Time",
    　   y = "Ratio") +
    facet_wrap(~factor(Type,levels = c("Time series","10 years","20 years"))) +
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = -Inf),col = "#c7c7c7",fill = "#c7c7c7", alpha = 0.009) +
    theme(
        axis.text=element_text(size=15,face ="bold"),
        axis.title=element_text(size=15,face="bold"),
        strip.text.x = element_text(size = 20),
        legend.position = "top",
        legend.title = element_text(size = 15,face="bold"),
        legend.text = element_text(size = 12),
        #legend.background = element_rect(linetype = 1, size = 1, colour = 1),
        plot.title = element_text(hjust = 0.5,face = "bold",size = 20),
        plot.subtitle = element_text(hjust = 0.5)) +
  　scale_fill_manual(values=c("MSY漁獲政策"="#35a16b","現状維持政策"="#ff2800"))

   gg2

  #保存
setwd("/Volumes/GoogleDrive/Shared drives/gakuLab_Research_Upside/Upside-prefecture/Outputs/UpsidePrefAnalysisOutput/移動平均で示す原料供給割合")
ggsave(file = "Miyagi_jp.png",plot = gg2,dpi = 350,width = 7.29,height = 4.51)
```

## <学会用>

```{r}
sanriku <- UpsideResultDetail %>%
  filter(alphabet %in% c("iwate","miyagi"))

#魚種数のチェック　：88魚種
unique(sanriku$fish_stock)

#岩手県の場合：88魚種
unique(filter(UpsideResultDetail,alphabet=="iwate")$fish_stock)

#宮城県の場合：88魚種
unique(filter(UpsideResultDetail,alphabet=="miyagi")$fish_stock)

#加工と漁獲が強い魚種は、、、（双方が強ければ地場加工の論理が強まる）
#マグロ、カツオ、さけ・ます、サンマ、タラ、イカ
#カツオの場合
sanriku_katsuo <- sanriku %>%
  filter(fish_stock == "skipjack_single_stock",year>2015,alphabet=="miyagi",management %in% c("SQ","FMSY"))

#マグロの場合
sanriku_tuna <- sanriku %>%
  filter(fish_stock %in% c("bluefin_tuna_single_stock","yellowfin_tuna_single_stock","bigeye_tuna_single_stock","albacore_tuna_single_stock"),year>2015,alphabet=="miyagi",management %in% c("SQ","FMSY")) %>%
  group_by(year,management) %>%
  summarise(pref_catch_All_Tuna = sum(pref_catch)) %>%
  rename(pref_catch = pref_catch_All_Tuna)

#さけ・ます類（岩手・宮城どっちもなので分ける）
sanriku_sakemasu <- sanriku %>%
  filter(fish_stock %in% c("salmon_single_stock","trout_single_stock"),year>2015,management %in% c("SQ","FMSY")) %>%
  group_by(year,management,alphabet) %>%
  summarise(pref_catch_All_Tuna = sum(pref_catch)) %>%
  rename(pref_catch = pref_catch_All_Tuna)
#さけ・ます類＿岩手県
sanriku_sakemasu_iwate <- filter(sanriku_sakemasu,alphabet=="iwate")
#さけ・ます類＿宮城県
sanriku_sakemasu_miyagi <- filter(sanriku_sakemasu,alphabet == "miyagi")

#さんま
sanriku_sanma <- sanriku %>%
  filter(fish_stock == "saury_single_stock",year>2015,management %in% c("SQ","FMSY")) %>%
  group_by(year,management,alphabet) %>%
  summarise(pref_catch_All = sum(pref_catch)) %>%
  rename(pref_catch = pref_catch_All)
#さんま＿岩手県
sanriku_sanma_iwate <- filter(sanriku_sanma,alphabet=="iwate")
#さんま＿宮城県
sanriku_sanma_miyagi <- filter(sanriku_sanma,alphabet == "miyagi")

#たら類（岩手・宮城どっちもなので分ける）
sanriku_tara <- sanriku %>%
  filter(fish_stock %in% c("cod_pacific_north_stock","pollock_pacific_stock"),year>2015,management %in% c("SQ","FMSY")) %>%
  group_by(year,management,alphabet) %>%
  summarise(pref_catch_All_Tuna = sum(pref_catch)) %>%
  rename(pref_catch = pref_catch_All_Tuna)
#たら類＿岩手県
sanriku_tara_iwate <- filter(sanriku_tara,alphabet=="iwate")
#たら類＿宮城県
sanriku_tara_miyagi <- filter(sanriku_tara,alphabet == "miyagi")


#当チャンクにおける共通作図ファンクション
gg_sanriku <- function(x,title){ggplot(x,aes(x=year,y=pref_catch,color = management)) +
  theme_bw() +
  geom_line(size=1.5)+
  scale_x_continuous(breaks = c(2016,2025,2035,2045,2055,2065)) + 
  #scale_y_continuous(breaks = c(0,10,20,30,40,50,60))+
  labs(y="Catch (t)",x="Year",title = title) +
  scale_color_manual(values=c("FMSY"="#35a16b","SQ"="#ff2800")) +
  theme(axis.text=element_text(size=15,face ="bold"),
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.title=element_text(size=20,face="bold"),
        legend.position = "none",
        plot.title = element_text(family = "Osaka",size = 22)
        )
}


gg_sanriku(sanriku_katsuo,"カツオ＿宮城県")
gg_sanriku(sanriku_tuna,"マグロ類＿宮城県")
gg_sanriku(sanriku_sakemasu_iwate,"さけ・ます類＿岩手県")
gg_sanriku(sanriku_sakemasu_miyagi,"さけ・ます類＿宮城県")
gg_sanriku(sanriku_sanma_iwate,"サンマ＿岩手県")
gg_sanriku(sanriku_sanma_miyagi,"サンマ＿宮城県")
gg_sanriku(sanriku_tara_iwate,"たら類＿岩手県")
gg_sanriku(sanriku_tara_miyagi,"たら類＿宮城県")
```

## <修論用> 三陸の魚種リスト

```{r}
dt.catch<-read.csv("/Volumes/GoogleDrive/My Drive/Upside-prefecture/Data_Working/CatchJPN1956_2020.csv",stringsAsFactors = F,fileEncoding = "Shift_JIS")

sanriku_list <- dt.catch %>%
  filter(alphabet %in% c("iwate","miyagi"),
         year > 2016) %>%
  mutate(Pref_Eng = ifelse(alphabet == "iwate","Iwate","Miyagi")) %>%
  group_by(Pref_Eng,fish) %>%
  mutate(Total_Catch_t = sum(as.numeric(catch_t),na.rm = T)) %>%
  ungroup() %>%
  group_by(Pref_Eng) %>%
  mutate(Pref_Total_Catch_t = sum(as.numeric(catch_t),na.rm  = T)) %>%
  ungroup() %>%
  summarise(Pref_Eng,
            Fish_Name = fish,
            Catch_Share = Total_Catch_t / Pref_Total_Catch_t) %>%
  unique()

sanriku_list_wider <- pivot_wider(sanriku_list,names_from = "Pref_Eng",values_from = "Catch_Share")
```